<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="@{layouts/default_layout}"
	layout:fragment="content">
<head>
<meta charset="UTF-8">
<title>여행 메이트 상세 조회</title>
<!-- index.html 고유 CSS 추가 -->
<th:block layout:fragment="css"></th:block>
<!-- index.html 고유 스크립트 추가 -->
<th:block layout:fragment="script"></th:block>
<style>
body {
	background-color: #fff;
	font-family: 'Roboto', sans-serif;
	font-weight: 400;
	color: #333;
}

h1 {
	color: #333;
}

table {
	width: 100%;
	border-collapse: collapse;
	margin-bottom: 20px;
}

th, td {
	padding: 10px;
	text-align: left;
	border: 1px solid #ddd;
}

th {
	background-color: #f5f5f5;
}

textarea {
	width: 100%;
	padding: 10px;
	border: 1px solid #ddd;
	resize: none;
}

button {
	background-color: #333;
	color: #fff;
	border: none;
	padding: 10px 20px;
	cursor: pointer;
}

button:hover {
	background-color: #222;
}

p {
    padding: 5px;
    margin-bottom: 5px;
    margin-left : 10px;
}

table {
	width: 100%;
	border-collapse: collapse;
	margin-bottom: 20px;
	margin: 10px;
	padding: 10px;
}
    .report-form {
        display: inline;
        background-color: #f2f2f2;
        padding: 10px;
        border-radius: 5px;
    }

    .report-form label {
        font-weight: bold;
    }

    .report-form select {
        width: 200px;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 3px;
    }

    .report-form input[type="submit"] {
        background-color: #333;
        color: white;
        padding: 8px 16px;
        border: 1px solid black;
        border-radius: 0;
        cursor: pointer;
    }

    .report-form input[type="submit"]:hover {
        background-color: #222;
    }
    
    #comment_table  {
    	width: 100%;
    	border-top: 1px solid rgba(50, 50, 50, 0.2);
    	border-collapse: collapse;
  	}
  
	#comment_table th, td {
		background-color: white;
    	border-bottom: 1px solid rgba(50, 50, 50, 0.2);
    	padding: 10px;
    	margin: 10px;
  	}

	#comment_table td a {
		text-decoration: none;
  	}
  	/*모달 창*/

* {
  padding:0;
  margin:0;
  box-sizing: border-box;
}

#btnWrap {
  width: 500px;
  margin: 100px auto;
}
#popupBtn {
  width: 150px;
  height: 50px;
  padding: 10px 5px;
}
#modalWrap {
  position: fixed; /* Stay in place */
  z-index: 1; /* Sit on top */
  padding-top: 100px; /* Location of the box */
  left: 0;
  top: 0;
  width: 100%; /* Full width */
  height: 100%; /* Full height */
  overflow: auto; /* Enable scroll if needed */
  background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
  display: none;
}

#modalBody {
  width: 500px;
  height: 300px;
  padding: 30px 30px;
  margin: 0 auto;
  border: 1px solid #777;
  background-color: #fff;
}
</style>
</head>
<body>
	<div align="center">
		<br>
		<br>
		<h1>여행 메이트 글 상세보기</h1>
		<br>
	</div>
	<div id="ls2" align="center">
		<table border="1" style="width: 80%;">
			<tr>
				<th width="70">여행 지역</th>
				<td width="50" align="center" th:text="${tripMateInfo.tripArea}" ></td>
				<th width="100">작성자</th>
				<td width="150" align="center" th:text="${tripMateInfo.writerId}"></td>
				<th width="100">등록일자</th>
				<td width="150" align="center" th:text="${#dates.format(tripMateInfo.writeDate, 'yy년 MM월 dd일 hh:mm:ss')}"></td>
				<th width="100">조회수</th>
				<td width="70" align="center" th:text="${tripMateInfo.hit}"></td>
			</tr>
			<tr>
				<th colspan="2">여행 타이틀</th>
				<td colspan="6" align="center" th:text="${tripMateInfo.mateTitle}">
				</td>
			</tr>
			<tr>
				<th colspan="1">여행 기간</th>
				<td colspan="3" align="center">[[${#dates.format(tripMateInfo.startDay, 'yy년 MM월 dd일')}]] ~ [[${#dates.format(tripMateInfo.endDay, 'yy년 MM월 dd일')}]]</td>
				<th width="100">모집 인원</th>
				<td width="110" align="center" th:text="${tripMateInfo.mateMax}"></td>
				<th width="100">신청 인원</th>
				<td width="110" align="center" id="applyNum" th:text="${tripMateInfo.applyNum}"></td>
			</tr>
			<tr>
				<td colspan="8">
				<th:textarea rows="30" th:utext="${tripMateInfo.mateContent}" readonly ></th:textarea>
				</td>
			</tr>
		</table>
		<table>
			<thead>
				<tr>
					<th>아이디</th>
					<th>생년월일</th>
					<th>성별</th>
					<th>국적</th>
				</tr>
			</thead>
			<tbody>
				<th:block th:each="tripMateInfo : ${member}">
					<tr th:class="btnWrap">
						<td th:text="${tripMateInfo.memberId}" th:value="${tripMateInfo.postId}"></td>
						<td th:text="${#dates.format(tripMateInfo.birthDate, 'yyyy-MM-dd')}"></td>
						<td th:text="${tripMateInfo.gender}"></td>
						<td th:text="${tripMateInfo.nationality}"></td>
					</tr>
				</th:block>
			</tbody>
		</table>

	
	<div id="modalWrap">
	  <div id="modalContent">
	    <div id="modalBody">
	     <div id="modalData">
	     </div>
	     <button type="button" id="cancle">신청 반려</button>	
	     <button type="button" id="closeBtn">취소</button>
	    </div>
	  </div>
	</div>
	</div>
	<div align="center">
		<form id="sendData" action="tripMateApplyForm" method="post">
			<input type="hidden" name="postId" th:value="${tripMateInfo.postId}">
			<input type="hidden" name="mateWriter" th:value="${tripMateInfo.writerId}">
			<button th:if="${session.sessionId} != null and ${session.sessionId} != ${tripMateInfo.writerId}" type="submit" class="feature-btn">
			신청하기</button>&nbsp;&nbsp;
			<button th:if="${session.sessionId} != null and ${session.sessionId} == ${tripMateInfo.writerId}" type="button" class="feature-btn" 
			th:onclick="|location.href='@{/mateRecruitUpdateForm(postId=${tripMateInfo.postId})}'|">수정</button>&nbsp;&nbsp;
			<button th:if="${session.sessionId} != null and ${session.sessionId} == ${tripMateInfo.writerId}" type="button" class="feature-btn" 
			th:onclick="|location.href='@{/mateRecruitDelete(postId=${tripMateInfo.postId})}'|">삭제</button>&nbsp;&nbsp;
			<button type="button" class="feature-btn" onclick="history.back()">목록으로</button>
		</form>
	</div>
	<!-- 댓글 기능 -->
	<div align="center">
		<form id="form" method="post">
			<table id="comment_table" style="font-size:0.9em; text-align: center;width: 1070px; margin: 0 auto; height : 60px; background-color: white;">
				<tr>
					<td>
					<input type="hidden" id="postId" th:value="${tripMateInfo.postId}">
					<input type="hidden" id="writerId" th:value="${session.sessionId}">
					</td>
					<td colspan="3"><textarea rows="3" cols="50" id="cmtContent"></textarea></td>
					<td>
						<input type="button" id="cmtSave" value="댓글작성">
						<input type="button" id="callCmt" value="댓글보기">
					</td>
				</tr>
			</table>
		</form>
	</div>
	
	<script th:inline="javascript">
	
	$(document).ready(function() {  
	
		//ajax 댓글 리스트 출력
		
		function showComment(){
			
		}
		
		//ajax를 통해서 해당 게시글의 포스트 아이디를 보내서 결과 값을 리스트로 담아서 가져옴.
	    $('#callCmt').click(function() {
		    $.ajax({
		            url: '/commentList',
		            type: 'get',
		            data: {postId : [[${tripMateInfo.postId}]]}
		           }).done(data => {
		              //console.log(postId);
		              //console.log(data);
		              showComment(data);
		           }).fail(reject => console.log(reject));
		         })
	
	
		//ajax 댓글 등록
		$("#cmtSave").click(function() {
			//session에 아이디 값이 없으면 로그인 페이지 호출
			if ('${session.sessionId}' == "") {
				alert("로그인이 필요합니다.")
				location.href="/member/login"
			}else{
				var writer = [[${session.sessionId}]];
				var content = $("#cmtContent").val();
				var postId = $("#postId").val();
				var step = 0; //(부모)댓글일 경우 step 는 0
				var obj = {
						writerId : writer,
						cmtContent : content,
						postId : postId,
						step : step,
				}
		
				//댓글 내용이 미 작성시 알림호출 후 포커스 이동 
				if(content=="") {
					alert("댓글 내용을 입력하세요.");
					$("#cmtContent").focus();
				}else{
					//댓글 내용이 존재하면 ajax를 통해 저장 기능 실행
					$.ajax({
						url: '/insertComment',
						type: 'post',
						data: obj
					}).done(data => {
						alert("댓글이 등록 되었습니다.");
						$("#cmtContent").val("");  
					}).fail(reject => console.log(reject));
				}
			}
		})	

		//modal 창 띄우는 구문
		var btn = $("#btnWrap");
		const modal = document.getElementById('modalWrap');
		const closeBtn = document.getElementById('closeBtn');
		
		$(".btnWrap").click(function() {
			//모달창 띄우기
			modal.style.display = 'block';
			//데이터값 가져와서 ajax 통신
			var memberId = $(this).find("td:eq(0)").text();
			var postId = $(this).find("td:eq(0)").attr('value');
			$.ajax({
				type : 'get',
				url: '/common/ajaxMember',
				data: { memberId : memberId, 
						postId : postId }
			}).done(data => {
				modalInfo(data)
			}).fail(reject => console.log(reject));
			  });
		  closeBtn.onclick = function() {
		    modal.style.display = 'none';
		  }
			  
		  window.onclick = function(event) {
		    if (event.target == modal) {
		      modal.style.display = "none";
		    }
		  }
		  //ajax 통신으로 모달창 데이터 띄우기
		function modalInfo(data){
			var modal = $("#modalData")
			var modalInfo = "";
			modalInfo = `
				<input type="hidden" id="dataPostId" value="${data.postId}">
				<input type="hidden" id="dataApplyId" value="${data.applyId}">
				<input type="hidden" id="dataMemberId" value="${data.memberId}">
				<label>이름</label>
				<input type="text" value="${data.memberName}" readonly><br>
				<label>성별</label>
				<input type="text" value="${data.gender}" readonly><br>
				<label>국적</label>
				<input type="text" value="${data.nationality}" readonly><br>
				<label>생년 월 일</label>
				<input type="text" value="${data.birthDate}" readonly><br>
				<label>신청 내용</label>
				 <input type="text" value="${data.applyInfo}" readonly><br>
			`
			modal.html(modalInfo);
		}
		  //신청반려버튼
		$("#cancle").click(function(){
			var postId = $("#dataPostId").val()
			var applyId = $("#dataApplyId").val()
			var memberId = $("#dataMemberId").val()
			var applyNum = parseInt($("#applyNum").text());
			
			console.log(postId + ", " +applyId)
			$.ajax({
			       url: '/common/myPageMyCancle',
			        type: 'post',
			        data: {postId : postId,
			        	   applyId : applyId,
			        	   memberId : memberId
			        }
			       }).done(data => {
			    	   modal.style.display = "none";
			    	   $('tr.btnWrap').each(function() {
			                var memberId = $(this).find('td:eq(0)').text();
			                if (memberId === data.data.memberId) {
			                    $(this).remove();
			                    var newApplyNum = applyNum - 1;
			                    $("#applyNum").text(newApplyNum);
			                }
			            });
			       }).fail(reject => console.log(reject));

	     })
	})
		//보낸 데이터 확인 작업
		function confirmCode(){
			   
			   var number1 = $("#smsCode").val();
			   var number2 = $("#numValue").val();
			   
		        if (number1 == number2) { // 저장된 SMS 코드를 사용
		            alert("인증되었습니다.");
		        } else {
		            alert("번호가 다릅니다.");
		        }
		    }
	</script>
</body>
</html>