<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="@{layouts/default_layout}">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
	rel="stylesheet"
	> -->
<!-- <script src="https://cdn.ckeditor.com/ckeditor5/12.4.0/classic/ckeditor.js">
</script>
 -->
<script src ="ckeditor5-build-classic/ckeditor.js"></script>
<style>
.ck.ck-editor {
	width: 80%;
	max-width: 800px;
	margin: 0 auto;
}

.ck-editor__editable {
	height: 80vh;
}

form {
	text-align: center;
}
#tourTheme{
	margin: 0 auto;
}

</style>
<!-- CKEditor -->
<!-- <script src="https://ckeditor.com/apps/ckfinder/3.5.0/ckfinder.js"></script> -->
<script>
$(document).ready(function() {	

ClassicEditor
	.create(document.querySelector('#editor'), {
		/* htmlEncodeOutput: false, */
		ckfinder: {
			uploadUrl : 'upload'	
		}
	
		
	})
	.then(editor => {
		console.log('Editor was initialized');
		
		document.getElementById("cancelBtn").addEventListener("click",function(){
			const data = editor.getData();
			//Data 변수에 저장된 데이터를 파싱하여 이미지 태크를 찾음
			const imgTags = Array.from(new DOMParser().parseFromString(data, 'text/html').querySelectorAll('img'));
			
			const filenames = imgTags.map(img=> {
				const src = img.getAttribute('src');
				
				return src.substring(src.lastIndexOf('/')+1);
			});
			console.log(filenames);
			fetch(`/deleteImg`,{
				method: 'POST',
				headers:{
					'Content-Type':'application/json'
				},
				body: JSON.stringify({ filenames })
			})
			.then(response => response.text())
			.then(message => {
				console.log(message);
				editor.setData('');
			})
			
		})
		
		
		var formObj = $("#editorForm");
		
		//document.getElementById("editorForm").addEventListener("submit",function(event){
		$("button[type='submit']").on("click",function(event){
				
			event.preventDefault();
	
			const data = editor.getData();
			
			let objData = serializeObject();
			
			//sconsole.log(data);
			const { tourTheme, name, price, startDate, endDate, deadlineDate, maxReservation } = objData;
			var combinedData={
				content: data,
				tourTheme: tourTheme,
		        name: name,
		        price: price,
		        startDate: startDate,
		        endDate: endDate,
		        deadlineDate: deadlineDate,
		        maxReservation: maxReservation
			};
			console.log(combinedData);
		/* 	var xhr = new XMLHttpRequest();
			
			
			xhr.onreadystatechange = function(){
				if(xhr.readyState==4&&xhr.status==200){
					
				}
			}
			xhr.open("post","insertEditor",true);
			xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
			xhr.send(data); */
			
			
			/*$.ajax({
				url:'insertFormData',
				data: JSON.stringify(combinedData),
				type: 'POST',
				contentType: 'application/json',
				dataType: 'json',
				success: function(result){
					console.log(result);
				},
				error : function(error){
					console.log(error)
				}
			});*/
			
			var str="";
			$(".uploadResult ul li").each(function(i,obj){
				var jobj = $(obj);
				str += "<input type ='hidden' name='attachList["+i+"].originImg' value='"+jobj.data("filename")+"'>";
				str += "<input type ='hidden' name='attachList["+i+"].savedImg' value='"+jobj.data("path")+"'>";
				str += "<input type ='hidden' name='attachList["+i+"].imgType' value='"+jobj.data("type")+"'>";
				str += "<input type ='hidden' name='attachList["+i+"].loadingImg' value='"+jobj.data("loadingpath")+"'>";
				
			});
			str +="<input type='hidden' name='content' value='"+combinedData.content+"'>";
			
			
			const imgTags = Array.from(new DOMParser().parseFromString(data, 'text/html').querySelectorAll('img'));
			
			const filenames = imgTags.map(img=> {
				const src = img.getAttribute('src');
				return src;
			});		
			$.each(filenames,function(i,obj){
				str += "<input type ='hidden' name='editorAttachList["+i+"].savedImg' value='c:/"+obj+"'>";
			});
					
			//filenames.forEach(function(src, i) {
			   // var jobj = $(imgTags[i]);
			    //console.log(jobj);
			    //str += "<input type ='text' name='attachList[" + i + "].originImg' value='" + jobj. + "'>";
			    //str += "<input type ='text' name='attachList[" + i + "].savedImg' value='" + jobj.data("path") + "'>";
			    //str += "<input type ='text' name='attachList[" + i + "].imgType' value='" + jobj.data("type") + "'>";
			//});
	
			formObj.append(str);
			document.getElementById('editorForm').action = "register";
			document.getElementById('editorForm').submit();
			

		})
		//////////////////////////////////////////////////////////////////////
	})
	.catch(error => {
		console.error(error);
	});
	
	function serializeObject(){
		let formData = $('form').serializeArray();
		let formObject={};
		$.each(formData, function(idx,obj){
			//let field = obj.name;
			//let val= obj.value;
			formObject[obj.name] = obj.value;
			//formObject[field] = val;
		});
		
		return formObject;
	}
	var cloneObj = $(".uploadDiv").clone();
	
	$(function(){
		$("#uploadBtn").on('click',function(e){
			e.preventDefault();
			let imageData = new FormData();
			
			let inputTag = document.querySelector('input[name="mainImage"]');
			
			let files = inputTag.files;
			
			for(let i=0; i<files.length; i++){
				console.log(files[i]);
				imageData.append("mainImage",files[i]);
			}
		
			$.ajax({
				url:'mainImageUpload',
				processData: false,
				Type: false,
				data: imageData,
				type:'POST',
				dataType:'json',
				success: function(result){
					alert("성공");
					
					console.log(result);
					
					showUploadedFile(result);
					
					$(".uploadDiv").html(cloneObj.html());
				}
			});
			//readURL(this);	
		});
	});

	/* document.getElementById("packageInfo").addEventListener("submit",function(event){
		
	}) */
	
	$(".uploadResult").on("click","span",function(e){
		var targetFile = $(this).data("file");
		var clickedSpan = $(this);
		$.ajax({
			url:'deleteFile',
			data: {savedImg: targetFile},
			dataType: 'text',
			type: 'POST',
			success: function(result){
				alert(result);
				//$(this).closest("li").load();
				var currentNode = clickedSpan.closest("li");
				var prevNode = currentNode.prev();
				var nextNode = currentNode.next();
				
				currentNode.add(prevNode).add(nextNode).remove();
				
				//clickedSpan.closest("li").prev().remove();
				//clickedSpan.closest("li").next().remove();
				//$(this).closest(li).load(window.location.href + "#div의 id");
			}
		})
	})
	
	var uploadResult = $(".uploadResult ul");
	
	function showUploadedFile(uploadResultArr){
		var str = "";
		$(uploadResultArr).each(function(i,obj){
			//str += "<li>" + obj.originImg + "</li>";
			
			var fileCallPath = encodeURIComponent(obj.savedImg);
			
			//str += "<li><img src='display?savedImg="+fileCallPath+"'>"+"<span data-file=\'"+fileCallPath+"\'> X </span>"+"<li>";
			
			str += "<li data-path='"+obj.savedImg+"'";
			str +=" data-filename='"+obj.originImg+"' data-type='"+obj.imgType+"'";
			str +=" data-loadingpath='"+obj.loadingImg+"'"+"><div>";
			str +="<span> " + obj.originImg +"</span>";
			str +="<img src='display?savedImg="+fileCallPath+"'>"+"<span data-file=\'"+fileCallPath+"\'> X </span>"+"</div>"+"</li>";
		});
		uploadResult.append(str);
	}
	
	
});
</script>
</head>
<body>
<div layout:fragment="content">
	<form method="post" id="editorForm" enctype="multipart/form-data" >
		<div id="packageInfo">	
			<div>
				<label>테마</label>
				<select name="tourTheme" id="tourTheme">
					<option value="맛집 투어">맛집 투어</option>
					<option value="관광 명소 투어">관광 명소 투어</option>
					<option value="쇼핑 여행">쇼핑 여행</option>
					<option value="도시 여행">도시 여행</option>
				</select>	
			</div>	
			<div class="uploadDiv">
				<input type="file" name="mainImage" id="mainImage" multiple/>
			</div>
			<button id ="uploadBtn">upload</button>
			<div class="uploadResult">
				<ul>
				
				</ul>
			</div>
			<div>
				<label>패키지 명</label>
				<input type="text" placeholder="패키지 명" name="name" id="name"/>
			</div>
			
			<div>
				<label>패키지 가격</label>
				<input type="text" placeholder="판매가" name="price" id="price"/>
			</div>
			<div>
			
			</div>
			<div>
				<p>패키지 기간</p>
				<label>시작일</label>
				<input type="date" name="startDate" id="startDate"/>
				<label> ~ 종료일</label>
				<input type="date" name="endDate" id="endDate"/>
			</div>
			
			<div>
				<label>모집 종료일</label>
				<input type="date" name="deadlineDate" id="deadlineDate"/>
			</div>
			
			<div>
				<label>모집 인원</label>
				<input type="number" name ="maxReservation" id="maxReservation"/>
			</div>
		</div>
		<h5>패키지 설명</h5>
		<div id="editor">
		
		</div>
		<button type="submit" class="btn btn-primary mt-3 mx-2" value="작성완료" >작성완료</button>
		<input type="button" class="btn btn-secondary mt-3 mx-2" value="작성취소" id="cancelBtn"/>
	</form>

</div>
</body>
</html>