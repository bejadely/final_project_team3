<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="@{layouts/default_layout}">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>

<style>
form {
	text-align: center;
}

.contentStyle{
	width:400px;
	height:400px;
	margin: 0 auto;
}
.pt img{
	width:200px;
	height:200px;
}

.review-content {
            position: relative;
            margin-bottom: 10px; /* 조절 가능한 여백 */
        }

        .review-content .writeDate {
            position: absolute;
            top: 0;
            right: 0;
        }

        .review-content .btn {
            position: relative;
            float: right;
        }
#select_count{
	display:block;
}
</style>

</head>
<body>

<div layout:fragment="content">
 <section class="property-details-section spad">
        <div class="container">
            <div class="row">
                <div class="col-lg-9">
                    <div class="pd-details-text">
                    <h4>[[ ${info.name} ]]</h4>
                        <div class="pd-details-social">
                            <a href="#"><i class="fa fa-facebook"></i></a>
                            <a href="#"><i class="fa fa-send"></i></a>
                            <a href="#"><i class="fa fa-star"></i></a>
                            <a href="#"><i class="fa fa-print"></i></a>
                            <a href="#"><i class="fa fa-cloud-download"></i></a>
                        </div>
                        <div class="property-more-pic">
                            <div class="product-pic-zoom">
                               
                            </div>
                            <div class="product-thumbs">
                                <div class="product-thumbs-track ps-slider owl-carousel">
                                    
                                </div>
                            </div>
                        </div>
                       
                        
                            <div class="pd-details-tab">
                            <div class="tab-item">
                                <ul class="nav" role="tablist">
                                    <li>
                                        <a class="active" data-toggle="tab" href="#tab-1" role="tab">패키지 정보</a>
                                    </li>
                                    <li>
                                        <a data-toggle="tab" href="#tab-2" role="tab">패키지 내용</a>
                                    </li>
                                    <li>
                                        <a data-toggle="tab" href="#tab-3" role="tab">Amenities</a>
                                    </li>
                                </ul>
                            </div>
                            <div class="tab-item-content">
                                <div class="tab-content">
                                    <div class="tab-pane fade-in active" id="tab-1" role="tabpanel">
                                        <div class="property-more-table">
                                            <table class="left-table">
                                                <tbody>
                                                    <tr>
                                                        <td class="pt-name">Price</td>
                                                        <td class="p-value">[[ ${info.price} ]]</td>
                                                    </tr>
                                                    <tr>
                                                        <td class="pt-name">패키지 테마</td>
                                                        <td class="p-value">[[ ${info.tourTheme} ]]</td>
                                                    </tr>
                                                    <tr>
                                                        <td class="pt-name">여행 시작일</td>
                                                        <td class="p-value">[[ ${#dates.format(info.startDate, 'yyyy년 MM월 dd일')} ]]</td>
                                                    </tr>
                                                    <tr>
                                                        <td class="pt-name">여행 종료일</td>
                                                        <td class="p-value">[[ ${#dates.format(info.endDate, 'yyyy년 MM월 dd일')} ]]</td>
                                                    </tr>
                                                    <tr>
                                                        <td class="pt-name">모집 마감일</td>
                                                        <td class="p-value">[[ ${#dates.format(info.deadlineDate, 'yyyy년 MM월 dd일')} ]]</td>
                                                    </tr>
                                                    <tr>
                                                        <td class="pt-name">모집 인원</td>
                                                        <td class="p-value">[[ ${info.maxReservation} ]]</td>
                                                    </tr>
                                                    <tr>
                                                        <td class="pt-name">Lot area</td>
                                                        <td class="p-value">200 spft</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                            <table class="right-table">
                                                <tbody>
                                                    <tr>
                                                        <td class="pt-name">Agent</td>
                                                        <td class="p-value">Adam Smith</td>
                                                    </tr>
                                                   <tr>
                                                        <td class="pt-name">Reference</td>
                                                        <td class="p-value">#2019</td>
                                                    </tr>
                                                    <tr>
                                                        <td class="pt-name">Contract type</td>
                                                        <td class="p-value">Sale</td>
                                                    </tr>
                                                    <tr>
                                                        <td class="pt-name">Beds</td>
                                                        <td class="p-value">4</td>
                                                    </tr>
                                                    <tr>
                                                        <td class="pt-name">Garages</td>
                                                        <td class="p-value">2</td>
                                                    </tr>
                                                    <tr>
                                                        <td class="pt-name">Home area</td>
                                                        <td class="p-value">1200 sqft</td>
                                                    </tr>
                                                    <tr>
                                                        <td class="pt-name">Gara Size</td>
                                                        <td class="p-value">200 sqft</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="tab-2" role="tabpanel">
                                        <div class="pd-table-desc" th:utext="${info.content }" >
                                           
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="tab-3" role="tabpanel">
                                        <div class="pd-table-amenities">
                                            <p>Learn how to improve your playing quality and even overall understanding
                                                of online gaming and how you perform while playing online. Gaming online
                                                is a huge business nowadays and that means that there are millions of
                                                people worldwide at online game sites all the time. Many are people just
                                                like you and me that like to play online and have fun doing it. Some of
                                                these people enjoy it so much, that they often do not even care about
                                                improving their skill and raising their chances of winning.</p>
                                            <p>Learn how to improve your playing quality and even overall understanding
                                                of online gaming and how you perform while playing online. Gaming online
                                                is a huge business nowadays and that means that there are millions of
                                                people worldwide at online game sites all the time. Many are people just
                                                like you and me that like to play online and have fun doing it. Some of
                                                these people enjoy it so much, that they often do not even care about
                                                improving their skill and raising their chances of winning.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    <!--<div class="pd-desc">
                            <h4>패키지 설명</h4>
                            <div th:utext="${info.content }" class="contentStyle"></div>
                        </div>-->
                    </div>
                </div>
               <div class="col-lg-3">
                    <div class="property-sidebar">
                        <h4>구매하기</h4>
                            <div class="sidebar-btn">
                                <div class="bt-item">
                                    <input type="radio" name="kakaoPay" id="kakaoPay" >
                                    <label for="kakaoPay">Buy</label>
                                </div>
                                <div class="bt-item">
                                    <input type="radio" name="cartBtn" id="cartBtn">
                                    <label for="cartBtn">Cart</label>
                                </div>
                            </div>
                          
							
							<!-- 총 금액 표시 -->
						
							<div id="packagePrice">
								가격 : <span class="price">[[${info.price}]]</span>원
							</div>
							<div class="form-horizontal" style="text-align: left;">
								<label>구매수량  </label> 
								<select class="nice-select form-control count" id="select_count" >
								   
								</select>
							</div>
							<div class="selected_option" style="text-align: right;">
							</div>
							
							
                    </div>
                </div>
            	<div>
	                <input type="hidden" id="sessionAuthority" th:value="${session.sessionAuthority}">
	                <button th:if="${session.sessionAuthority} != null and ${session.sessionAuthority} == 'A2'" type="button" class="btn btn-outline-dark" 
					th:onclick="|location.href='@{/guide/packageUpdateForm(postId=${info.postId})}'|">수정</button>&nbsp;&nbsp;
                </div>
            </div>
            <!-- 리뷰 -->
	        <div class="review">
	            <h7 id="reviewCount"></h7>
	            <hr>
	            <hr id="afterReview">
	            <div class="d-grid gap-2 col-6 mx-auto">
	                <button class="btn btn-outline-info justify-content-center" id="moreReview" type="button"
	                        data-page="1" >
	                    더보기
	                </button>
	            </div>
	            <hr>
	            <div class="form-check form-check-inline">
	                <input class="form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio1" value="1">
	                <label class="form-check-label" for="inlineRadio1">1점</label>
	            </div>
	            <div class="form-check form-check-inline">
	                <input class="form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio2" value="2">
	                <label class="form-check-label" for="inlineRadio2">2점</label>
	            </div>
	            <div class="form-check form-check-inline">
	                <input class="form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio3" value="3">
	                <label class="form-check-label" for="inlineRadio3">3점</label>
	            </div>
	            <div class="form-check form-check-inline">
	                <input class="form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio4" value="4">
	                <label class="form-check-label" for="inlineRadio4">4점</label>
	            </div>
	            <div class="form-check form-check-inline">
	                <input class="form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio5" value="5" th:checked="true">
	                <label class="form-check-label" for="inlineRadio5">5점</label>
	            </div>
	            <div class="input-group mb-3">
	                <input id="reviewInput" type="text" class="form-control" placeholder="리뷰 작성" aria-label="추억을 남겨보세요!" aria-describedby="button-addon2">
	                <button class="btn btn-outline-secondary" type="button" id="addReview">리뷰 등록</button>
	            </div>
	        </div>	
        </div>
        
        		
    </section>
    <!-- Property Details Section End -->
	 <div class="partner-section">
        <div class="container">
            <div class="partner-carousel owl-carousel">
                <a href="#" class="partner-logo">
                    <div class="partner-logo-tablecell">
                        <img src="img/partner/partner-1.png" alt="">
                    </div>
                </a>
                <a href="#" class="partner-logo">
                    <div class="partner-logo-tablecell">
                        <img src="img/partner/partner-2.png" alt="">
                    </div>
                </a>
                <a href="#" class="partner-logo">
                    <div class="partner-logo-tablecell">
                        <img src="img/partner/partner-3.png" alt="">
                    </div>
                </a>
                <a href="#" class="partner-logo">
                    <div class="partner-logo-tablecell">
                        <img src="img/partner/partner-4.png" alt="">
                    </div>
                </a>
                <a href="#" class="partner-logo">
                    <div class="partner-logo-tablecell">
                        <img src="img/partner/partner-5.png" alt="">
                    </div>
                </a>
            </div>
        </div>
        <input type="hidden" id="id" th:value="${session.sessionId}">
    </div>
    <!-- Partner Carousel Section End -->
    
   

<script>
	var content = '[[${info.content }]]';
	var postId = '[[${info.postId}]]';
	var memberId = $("#id").val();
	
	$(document).ready(function(){
			
		(function(){
			$.getJSON("getAttachList",{postId:postId},function(arr){
				var str="";
				var str2="";
				$(arr).each(function(i, attach){
					if(i==0){
						str+=`<img src="${attach.loadingImg}" class="product-big-img"  alt="">`	
					}
					else{
						str2+=`<div class="pt" data-imgbigurl="${attach.loadingImg}"><img
                            src="${attach.loadingImg}" alt=""></div>`
					}
				});
				$(".product-pic-zoom").html(str);
				$(".product-thumbs-track.ps-slider.owl-carousel").html(str2);
			});
		})();
		   
	});
	 getPackageDetailInfoReview(postId, function(data) {
		 appendPackageDetailInfoReview(data, postId);   
     });
	 var maxReservation =parseInt('[[${info.maxReservation}]]');
	 var countSelect = document.getElementById("select_count");
	 for (var i = 0; i <= maxReservation; i++) {
		 var option = document.createElement('option');
         option.value = i;
         option.text = i;
         countSelect.appendChild(option);
     }
	 
	 $(document).on('click', '.nice-select.form-control', function() {
			//var count = $(this).attr("data-value");
			//var count = $(".current").text();
			var count = $("div.count  li.selected").attr("data-value");
			var finalPrice = 0;
			var str = '';
			var packagePriceDiv = $("#packagePrice");

			// div 요소 내부의 span 요소를 가져옵니다.
			var priceSpan = packagePriceDiv.find(".price");

			// span 요소의 텍스트 내용을 가져옵니다.
			var priceValue = parseInt(priceSpan.text());

			console.log(count)
			
			
			// 가져온 값을 출력하거나 다른 용도로 사용할 수 있습니다.
			console.log("가격: " + priceValue);
			finalPrice = priceValue * count;

			str += '<p><label>총 인원 : </label><span class="count">&nbsp;' + count + '</span>&nbsp;&nbsp;&nbsp;<br>';	
			str += '<h4><label>결제금액 : </label><span class="finalPrice">&nbsp;' + finalPrice + ' 원</span></h4>'; 
			
			
			$(".selected_option").html(str);
		});
	 
	 
	 
	 
	 
	

	    // 결제 버튼 클릭 이벤트 처리
	    document.getElementById('kakaoPay').addEventListener('click', function() {
	        // 여기에 결제 페이지로 이동하는 코드 추가
	        // 예를 들어, window.location.href = '결제페이지URL';
	        let totalAmount = parseInt($("#totalPrice").text());
	        let orderName = "[[ ${info.name} ]]";
	        let postId = "[[ ${info.postId} ]]"
	        let quantity = parseInt(document.getElementById('quantity').value);
	     console.log(totalAmount)
	     console.log(orderName)
	     console.log(quantity)
	     console.log(memberId)
	        $.ajax({
	        	type:'post',
	        	url:'payment/ready',
	        	data:{
	        		totalAmount: totalAmount,
	        		orderName : orderName,
	        		quantity : quantity,
	        		postId: postId,
	        		partnerUserId: memberId
	        	},
	        	success:function(response){
	        		location.href = response.next_redirect_pc_url
	        	}
	        	
	        });
	    });
	    
	    document.getElementById('cartBtn').addEventListener('click',function(){
	    	let totalAmount = parseInt($("#totalPrice").text());
	        let orderName = "[[ ${info.name} ]]";
	        let postId = "[[ ${info.postId} ]]"
	        let quantity = parseInt(document.getElementById('quantity').value);
	    	
	    	console.log(memberId);
	    	$.ajax({
	    		type:'post',
	    		url:'/common/cartInsert',
	    		data:{
	    			price: totalAmount,
	        		cartName : orderName,
	        		quantity : quantity,
	        		postId: postId,
	        		memberId : memberId			
	    		},
	    		success:function(message){
	    			alert(message);
	    		}
	    	});
	    });
	    
	    function getPackageDetailInfoReview(postId, callback) {
            $.ajax({
                type: 'GET',
                url: '/packageInfoReview',
                data: {
                    'postId': postId
                }
            })
            .done(function (data, textStatus, jqXHR){
                console.log('done');

                callback(data);
            })
            .fail(function (jqXHR, textStatus, errorThrown){
                console.log('fail');

                callback(null);
            })
        }
	    
	    function appendPackageDetailInfoReview(data, postId) {
	        $('#reviewCount').text(data.totalCount + '개의 리뷰');
	        $('#reviewCount').data('totalCount', data.totalCount);
	        if(data.totalCount == 0) {
	            $('#moreReview').addClass('disabled');
	        }
	        $('#moreReview').data('postId', postId);
	
	        if(data.packageDetailReviewVoList.length > 0) {
	            appendReview(data.packageDetailReviewVoList, postId);
	        }
	    }
	
	    //모달창 리뷰 페이징
	    $(document).on('click', '#moreReview', function () {
	        let page = $(this).data('page');
	
	        page = Number(page)+1;
	
	        $.ajax({
	            type: 'GET',
	            url: '/packageReview',
	            data: {
	                'postId' : postId,
	                'page' : page
	            }
	        })
	        .done(function(data, textStatus, jqXHR) {
	            console.log('done');
	
	            appendReview(data, postId);
	            changeInfoMoreReviewButton(page);
	        })
	        .fail(function(jqXHR, textStatus, errorThrown) {
	            console.log('fail');
	
	        })
	    });
	
	    function appendReview(data, postId) {
	        let node = ``;
	        for(let i = 0; i < data.length; i++) {
	            let stars = '';
	            for(let j = 1; j <= 5; j++) {
	                if(j <= data[i].grade) {
	                    stars += '★';
	                } else {
	                    stars += '☆';
	                }
	            }
	
	            let date = data[i].writeDate.substring(0,10);
	
	            node += `
	                <div class="review-content">
	                    <p>
	                        <span class="writerId">${data[i].writerId}</span>
	                        <span class="grade">${stars}</span>
	                        <span class="writeDate" style="float: right;">${date}&emsp;
	                            <button type="button" class="btn btn-secondary btn-sm deleteReview" data-content-id="${postId}" data-review-id="${data[i].reviewId}">삭제</button>
	                        </span>
	                        <br>
	                        <span class="content">${data[i].content}</span>
	                    </p>
	                </div>
	            `;
	        }
	        $('#afterReview').before(node);
	    }
	
	    function changeInfoMoreReviewButton(page) {
	        $('#moreReview').data('page', page);
	
	        let totalCount = $('#reviewCount').data('totalCount');
	        let reviewCount = $('.review-content').length;
	
	        if(totalCount == reviewCount) {
	            $('#moreReview').addClass('disabled');
	        }
	    }
	
	    //리뷰 등록
	    $(document).on('click', '#addReview', function() {
	        let contentId = $('#moreReview').data('postId');
	
	        let checkedgrade = $('input[name=inlineRadioOptions]:checked').val();
	        if(checkedgrade == null) {
	            alert("점수를 체크해주세요.");
	            return;
	        }
	
	        let reviewContent = $('#reviewInput').val();
	        if(reviewContent == null|| reviewContent.replaceAll(' ', '') == '') {
	            alert("내용을 입력해주세요.");
	            return;
	        }
	        //  ajax 들어가서 로그인 되어있는지 먼저 확인 - 안되면 바로 fail throw new Exception(); 예외 일부러 발생시켜주기
	        $.ajax({
	            type: 'POST',
	            url: '/common/packageReview',
	            data : {
	                'grade' : checkedgrade,
	                'content' : reviewContent,
	                'originPostId' : postId
	            }
	        })
	        .done(function (data, textStatus, jqXHR){
	            console.log('done');
	
	            //  data는 totalCount이고, x개의 리뷰를 바꿔야함
	            $('#reviewCount').text(data.totalCount + '개의 리뷰');
	            $('#reviewCount').data('totalCount', data.totalCount);
	
	            $('.review-content').remove();
	            appendReview(data.recentReviewList, postId);
	
	            changeInfoMoreReviewButton(1);
	            clearInput();
	
	            alert('리뷰가 등록되었습니다.');
	        })
	        .fail(function (jqXHR, textStatus, errorThrown) {
	            console.log('fail');
	
	            let errorMessage = JSON.parse(jqXHR.responseText).message;
	            if(errorMessage == 'no login') {
	                alert('로그인을 해주세요.');
	            } else if(errorMessage == 'not insert') {
	                alert('리뷰가 등록되지 않았습니다.');
	            }
	        })
	
	    })
	
	    //리뷰 삭제
	    $(document).on('click', '.deleteReview', function() {
	
	        let writerId = $(this).parent().siblings('.writerId').text();
	        let reviewId = $(this).data('reviewId');
	        //  ajax로 가서 session에 저장된 아이디랑 writerId랑 같은지 확인 - 같지 않다면 fail 
	        $.ajax({
	            type: 'DELETE',
	            url: "/common/packageReview",
	            data: {
	                'postId' : postId,
	                'writerId' : writerId,
	                'reviewId' : reviewId
	            }
	        })
	        .done(function (data, textStatus, jqXHR){
	            console.log('done');
	
	            $('#reviewCount').text(data.totalCount + '개의 리뷰');
	            $('#reviewCount').data('totalCount', data.totalCount);
	
	            $('.review-content').remove();
	            appendReview(data.recentReviewList, postId);
	
	            changeInfoMoreReviewButton(1);
	
	            alert('리뷰가 삭제되었습니다.');
	        })
	        .fail(function (data, textStatus, jqXHR) {
	            console.log('fail');
	
	            let errorMessage = JSON.parse(jqXHR.responseText).message;
	            if(errorMessage == 'no login') {
	                alert('로그인을 해주세요.');
	            } else if(errorMessage == 'not same') {
	                alert('본인의 리뷰만 삭제할 수 있습니다.');
	            } else if(errorMessage == 'not delete') {
	                alert('리뷰가 삭제되지 않았습니다.');
	            }
	        })
	
	    })
	
	    function clearInput() {
	        $('#reviewInput').val('');
	        $('#inlineRadio5').prop('checked', true);
	    }
    
</script>
</div>
</body>
</html>