<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="@{layouts/default_layout}">
<head>
<meta charset="UTF-8">
<meta name="description" content="Azenta Template">
<meta name="keywords" content="Azenta, unica, creative, html">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>여행경로 선택</title>
<!-- Google Font -->
<link
	href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700,800,900&display=swap"
	rel="stylesheet">
<!-- 고유 CSS 추가 -->
<th:block layout:fragment="css">
	<link rel="stylesheet" th:href="@{/css/map.css}" >
</th:block>
</head>
<body>
	<div layout:fragment="content">
		<div class="map_wrap" style="height:1000px; width:700px; border: solid 1px;">
			<div id="map" style="width: 100%; height: 100%; position: relative; overflow: hidden;"></div>
		<hr>
		<!-- 클릭 시 마커 생성 -->
		<div id="clickLatlng"></div>
	</div>
	<!-- 키워드 검색 -->
	<div class="option">
			<div>
				키워드 : <input type="text" value="" id="keyword" size="15">
				<button onclick="searchPlaces(); return false;">검색하기</button>
			</div>
	</div>
	<!-- 키워드 검색 결과를 나타냄 -->
	<div id="menu_wrap" class="bg_white" style="margin-left:710px; margin-top:250px; height:1000px; width:700px; border: solid 1px;">
		<ul id="placesList"></ul>
		<div id="pagination"></div>
	</div>
	<div id="wrapper">
		<script type="text/javascript"
			src="//dapi.kakao.com/v2/maps/sdk.js?appkey=d37c7ea721a01188dd47b9d069964fe4&libraries=services"></script>
		<script>
		
			// 마커를 담는 배열
			var markers = [];

			// 지도를 표시할 div
			var mapContainer = document.getElementById('map'), 
			mapOption = {
				// 최초로 생성된 지도의 중심좌표
				center : new kakao.maps.LatLng(35.871159972672, 128.60183648521),
				// 지도의 확대 레벨
				level : 5
			};

			// 지도 생성 
			var map = new kakao.maps.Map(mapContainer, mapOption);

			// 장소 검색 객체를 생성
			var ps = new kakao.maps.services.Places();

			// 검색 결과 목록이나 마커를 클릭했을 때 장소명을 표출할 인포윈도우를 생성
			var infowindow = new kakao.maps.InfoWindow({
				zIndex : 1
			});

			// 키워드로 장소검색
			searchPlaces();

			// 키워드 검색을 요청하는 함수
			function searchPlaces() {

				var keyword = document.getElementById('keyword').value;

				if (!keyword.replace(/^\s+|\s+$/g, '')) {
					alert('키워드를 입력해주세요!');
					return false;
				}

				// 장소검색 객체를 통해 키워드로 장소검색을 요청
				ps.keywordSearch(keyword, placesSearchCB);
			}

			// 장소검색이 완료됐을 때 호출되는 콜백함수
			function placesSearchCB(data, status, pagination) {
				if (status === kakao.maps.services.Status.OK) {

					// 정상적으로 검색이 완료 시 검색 목록과 마커를 표출합니다
					displayPlaces(data);

					// 검색 결과 리스트의 페이지 번호를 표출
					displayPagination(pagination);

				} else if (status === kakao.maps.services.Status.ZERO_RESULT) {

					alert('검색 결과가 존재하지 않습니다.');
					return;

				} else if (status === kakao.maps.services.Status.ERROR) {

					alert('검색 결과 중 오류가 발생했습니다.');
					return;

				}
			}

			// 검색 결과 목록과 마커를 표출하는 함수
			function displayPlaces(places) {

				var listEl = document.getElementById('placesList'), menuEl = document
						.getElementById('menu_wrap'), fragment = document
						.createDocumentFragment(), bounds = new kakao.maps.LatLngBounds(), listStr = '';

				// 검색 결과 목록에 추가된 항목들을 제거
				removeAllChildNods(listEl);

				// 지도에 표시되고 있는 마커를 제거
				removeMarker();

				for (var i = 0; i < places.length; i++) {

					// 마커를 생성하고 지도에 표시
					var placePosition = new kakao.maps.LatLng(places[i].y,
							places[i].x), itemEl = getListItem(
							i, places[i]); // 검색 결과 항목 Element를 생성

					// 검색된 장소 위치를 기준으로 지도 범위를 재설정하기위해
					// LatLngBounds 객체에 좌표를 추가합니다
					bounds.extend(placePosition);

					// 마커와 검색결과 항목에 mouseover 했을때
					// 해당 장소에 인포윈도우에 장소명을 표시합니다
					// mouseout 했을 때는 인포윈도우를 닫습니다
					(function(marker, pname, praddress, paddress, plat, plng) {
						kakao.maps.event.addListener(marker, 'mouseover',
								function() {
									displayInfowindow(marker, pname);
								});

						kakao.maps.event.addListener(map, 'mouseout',
								function() {
									infowindow.close();
								});

						// 리스트의 아이템을 클릭하면 정보들을 text 영역으로 전송 (hidden 사용가능)
						itemEl.onclick = function() {
							if (praddress) {
								document.getElementById('fulladdress').value = "["
										+ pname + "]" + praddress;
							} else {
								document.getElementById('fulladdress').value = "["
										+ pname + "]" + paddress;
							}

							document.getElementById('pname').value = pname;
							if (praddress) {
								document.getElementById('paddress').value = praddress;
							} else {
								document.getElementById('paddress').value = paddress;
							}
							document.getElementById('latclick').value = plat;
							document.getElementById('lngclick').value = plng;
							
							var markerPosition  = new kakao.maps.LatLng(plat, plng);
							var marker = new kakao.maps.Marker({

								map : map, // 마커를 표시할 지도

								position : markerPosition
							});
							
							
							var infowindow = new kakao.maps.InfoWindow({

								content : pname, // 인포윈도우에 표시할 내용

								removable : true

							});
							
							kakao.maps.event.addListener(marker, 'click', marker_click(map,
									marker, infowindow));
							
						};
						
						//리스트 정보 클릭 시 맵핑할지 선택하는 함수
						function call_confirm(){
							
							if(confirm("맵핑하시겠습니까?")){
								alert("맵핑 완료");
							}else{
								alert("맵핑 실패");
							}
							
						}
						
						// 마커가 표시될 위치입니다 
						//var markerPosition  = new kakao.maps.LatLng(33.450701, 126.570667); 

						
						itemEl.onmouseover = function() {
							displayInfowindow(marker, pname);
						};

						itemEl.onmouseout = function() {
							infowindow.close();
						};
					})(marker, places[i].place_name,
							places[i].road_address_name,
							places[i].address_name, places[i].y, places[i].x);

					fragment.appendChild(itemEl);
				}

				// 검색결과 항목들을 검색결과 목록 Elemnet에 추가합니다
				listEl.appendChild(fragment);
				menuEl.scrollTop = 0;

				// 검색된 장소 위치를 기준으로 지도 범위를 재설정합니다
				map.setBounds(bounds);
			}

			// 검색결과 항목을 Element로 반환하는 함수입니다
			function getListItem(index, places) {

				var el = document.createElement('li'), itemStr = '<span class="markerbg marker_'
						+ (index + 1)
						+ '"></span>'
						+ '<div class="info" style="cursor:pointer;">'
						+ '   <h5>' + places.place_name + '</h5>';

				if (places.road_address_name) {
					itemStr += '    <span>' + places.road_address_name
							+ '</span>' + '   <span class="jibun gray">'
							+ places.address_name + '</span>';
				} else {
					itemStr += '    <span>' + places.address_name + '</span>';
				}
				itemStr += '  <span class="tel">' + places.phone + '</span>';
				+'</div>';

				el.innerHTML = itemStr;
				el.className = 'item';

				return el;
			}

			// 마커를 생성하고 지도 위에 마커를 표시하는 함수입니다
			function addMarker(position, idx, title) {
				var imageSrc = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_number_blue.png', // 마커 이미지 url, 스프라이트 이미지를 씁니다
				imageSize = new kakao.maps.Size(36, 37), // 마커 이미지의 크기
				imgOptions = {
					spriteSize : new kakao.maps.Size(36, 691), // 스프라이트 이미지의 크기
					spriteOrigin : new kakao.maps.Point(0, (idx * 46) + 10), // 스프라이트 이미지 중 사용할 영역의 좌상단 좌표
					offset : new kakao.maps.Point(13, 37)
				// 마커 좌표에 일치시킬 이미지 내에서의 좌표
				}, markerImage = new kakao.maps.MarkerImage(imageSrc,
						imageSize, imgOptions), marker = new kakao.maps.Marker(
						{
							position : position, // 마커의 위치
							image : markerImage
						});

				marker.setMap(map); // 지도 위에 마커를 표출합니다
				markers.push(marker); // 배열에 생성된 마커를 추가합니다

				return marker;
			}
			
	          // 검색결과 목록 하단에 페이지 번호 표시
	          function displayPagination(pagination) {
	            var paginationEl = document.getElementById('pagination'),
	              fragment = document.createDocumentFragment(),
	              i

	            // 기존에 추가된 페이지 번호 삭제
	            while (paginationEl.hasChildNodes()) {
	              paginationEl.removeChild(paginationEl.lastChild)
	            }

	            for (i = 1; i <= pagination.last; i++) {
	              var el = document.createElement('a')
	              el.href = '#'
	              el.innerHTML = i

	              if (i === pagination.current) {
	                el.className = 'on'
	              } else {
	                el.onclick = (function (i) {
	                  return function () {
	                    pagination.gotoPage(i)
	                  }
	                })(i)
	              }

	              fragment.appendChild(el)
	            }
	            paginationEl.appendChild(fragment)
	          }

			// 지도 위에 표시되고 있는 마커를 모두 제거합니다
			function removeMarker() {
				for (var i = 0; i < markers.length; i++) {
					markers[i].setMap(null);
				}
				markers = [];
			}

			// 검색결과 목록 또는 마커를 클릭했을 때 호출되는 함수입니다
			// 인포윈도우에 장소명을 표시합니다
			function displayInfowindow(marker, title) {
				var content = '<div style="padding:5px;z-index:1;">' + title
						+ '</div>';

				infowindow.setContent(content);
				infowindow.open(map, marker);
			}

			// 검색결과 목록의 자식 Element를 제거하는 함수입니다
			function removeAllChildNods(el) {
				while (el.hasChildNodes()) {
					el.removeChild(el.lastChild);
				}
			}

			//첫번째 띄울 좌표

			var first_positions = [

					{

						content : '재운하우스',

						latlng : new kakao.maps.LatLng(35.839548949033336,
								128.60512942482416)

					},

					{

						content : '예담',

						latlng : new kakao.maps.LatLng(35.86907478334457,
								128.59329617304536)

					},

					{

						content : '덕화빌라',

						latlng : new kakao.maps.LatLng(35.8819957381611,
								128.565172316827)

					}

			];


			// 첫번째 마커 생성

			for (var i = 0; i < first_positions.length; i++) {

				// 마커를 생성합니다

				var marker = new kakao.maps.Marker({

					map : map, // 마커를 표시할 지도

					position : first_positions[i].latlng
				// 마커의 위치// 인포윈도우에 표출될 내용으로 HTML 문자열이나 document element가 가능합니다

				});

				// 마커에 표시할 인포윈도우를 생성합니다

				var infowindow = new kakao.maps.InfoWindow({

					content : first_positions[i].content, // 인포윈도우에 표시할 내용

					removable : true

				});

				kakao.maps.event.addListener(marker, 'click', marker_click(map,
						marker, infowindow));

			}

			function marker_click(map, marker, infowindow) {

				return function() {

					infowindow.open(map, marker);

				};

			}

			//선을 구성하는 좌표 배열입니다. 이 좌표들을 이어서 선을 표시합니다

			var first_polyline = [

			new kakao.maps.LatLng(35.839548949033336, 128.60512942482416),

			new kakao.maps.LatLng(35.86907478334457, 128.59329617304536),

			new kakao.maps.LatLng(35.8819957381611, 128.565172316827)

			];

			// 지도에 표시할 선을 생성합니다

			var first_linePath = new kakao.maps.Polyline({

				path : first_polyline, // 선을 구성하는 좌표배열 입니다

				strokeWeight : 3, // 선의 두께 입니다

				strokeColor : 'black', // 선의 색깔입니다

				strokeOpacity : 0.7, // 선의 불투명도 입니다 1에서 0 사이의 값이며 0에 가까울수록 투명합니다

				strokeStyle : 'solid' // 선의 스타일입니다

			});

			// 지도에 선을 표시합니다

			first_linePath.setMap(map);

			// 지도에 마커를 표시합니다
			marker.setMap(map);

			// 지도에 클릭 이벤트를 등록합니다
			// 지도를 클릭하면 마지막 파라미터로 넘어온 함수를 호출합니다
			//kakao.maps.event.addListener(map, 'click', function(mouseEvent) {        
			    
			    // 클릭한 위도, 경도 정보를 가져옵니다 
			    //var latlng = mouseEvent.latLng; 
			    
			    // 마커 위치를 클릭한 위치로 옮깁니다
			    //marker.setPosition(latlng);
			    
			    //var message = '클릭한 위치의 위도는 ' + latlng.getLat() + ' 이고, ';
			    //message += '경도는 ' + latlng.getLng() + ' 입니다';
			    
			    //var resultDiv = document.getElementById('clickLatlng'); 
			    //resultDiv.innerHTML = message;
			    
			//});
			
			
		</script>

		<div>
			<!-- 위도 및 경도 좌표 및 위치정보 -->
				<input type="text" id="fulladdress" name="fulladdress" style="width: 90%;" disabled> 
				<input type="text" id="pname" name="pname" value=""> 
				<input type="text" id="paddress" name="paddress" value=""> 
				<input type="text" id="latclick" name="latclick" value=""> 
				<input type="text" id="lngclick" name="lngclick" value="">
		</div>
	</div>
	</div>
</body>
</html>