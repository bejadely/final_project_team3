<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
   xmlns:th="http://www.thymeleaf.org"
   xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
   layout:decorate="@{layouts/default_layout}">
<head>
<meta charset="UTF-8">
<meta name="description" content="Azenta Template">
<meta name="keywords" content="Azenta, unica, creative, html">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>여행경로 선택</title>
<!-- Google Font -->
<link
   href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700,800,900&display=swap"
   rel="stylesheet">
<!-- 고유 CSS 추가 -->
<th:block layout:fragment="css">
   <link rel="stylesheet" th:href="@{/css/map.css}">
</th:block>
</head>
<body>
   <div layout:fragment="content">
      <div class="map_wrap"
         style="height: 800px; width: 700px; border: solid 1px;">
         <div id="map"
            style="width: 100%; height: 100%; position: relative; overflow: hidden;"></div>
         <hr>
         <!-- 클릭 시 마커 생성 -->
         <div id="clickLatlng"></div>
      </div>
      <div>
         <button type="submit" id="addMap">경로 추가</button>
         <div id="addSearchMap">
            <!-- 키워드 검색 결과를 나타냄 -->
            <div id="searchMap"
               style="height: 50px; width: 800px; border: solid 1px; margin-top: 10px;">
               <div style="margin-top: 10px; margin-left: 25px;">
                  <input type="text" value="" id="keyword" size="50"
                     placeholder="키워드를 입력 해주세요.">
                  <button onclick="initMap(); return false;">검색하기</button>
                  <button type="submit" id="mapping">경로 선택/수정</button>
               </div>
               <div id="menu_wrap" class="map_wrap"
                  style="margin-left: 710px; margin-top: 280px; height: 400px; width: 700px; border: solid 1px; display: none;">
                  <ul id="placesList"></ul>
                  <div id="pagination"></div>
               </div>
            </div>
            <button type="button" id="fixMap" style="display: none">경로
               수정</button>
            <!-- post_id 넘길때 사용? -->
            <form name="#" method="post" th:object="${tripVO}"
               enctype="multipart/form-data">
               <div id="showMapping"></div>
            </form>
         </div>

         <!--   
   <div id="div1">
         <input type="text" id="div1-keyword" size="50" placeholder="키워드를 입력 해주세요.">
         <button id="searchButton1">검색하기</button>
   </div>
   
   <div id="div2">
         <input type="text" id="div2-keyword" size="50" placeholder="키워드를 입력 해주세요.">
         <button id="searchButton2">검색하기</button>
   </div>
   -->
         <div id="wrapper"></div>
      </div>
      <script>
            // 마커를 담는 배열
            var markers = [];
            // 최종적으로 저장된 위도, 경도위 정보를 담아주는 배열
            var mapping = [];
            // 지도상의 선을 초기화
            var polyline = null;
         // 생성된 마커의 위도, 경도를 담아줄 변수
            var markerPosition ;
            // 지도를 표시할 div
            var mapContainer = document.getElementById('map'), mapOption = {
               // 최초로 생성된 지도의 중심좌표 
               //지금은 대구로 되어있지만 맵핑 등록기능 구현 완료 시 여행계획 등록시 선택한 지역의 시청 좌표값으로 변경할 예정
               center : new kakao.maps.LatLng(35.871159972672, 128.60183648521),
               // 지도의 확대 레벨
               level : 7
            };

            // 지도 생성 
            var map = new kakao.maps.Map(mapContainer, mapOption);

            // 장소 검색 객체를 생성
            var ps = new kakao.maps.services.Places();

            // 검색 결과 목록이나 마커를 클릭했을 때 장소명을 표출할 인포윈도우를 생성
            var infowindow = new kakao.maps.InfoWindow({
               zIndex : 1
            });
            
            $(document).ready(function() {
               // 승인 버튼 클릭 시 발생 이벤트 설정
               initMap; 
            });
            

            function performSearch(divId) {
                var keywordInput = document.getElementById(divId + '-keyword');
                var keyword = keywordInput.value;
            
                //.replace(/^\s+|\s+$/g 앞 뒤의 공백을 제거
                if (!keyword.replace(/^\s+|\s+$/g, '')) {
                    alert('키워드를 입력해주세요!');
                    return false;
                }

                ps.keywordSearch(keyword, function(data, status, pagination) {
                    if (status === kakao.maps.services.Status.OK) {
                        displayPlaces(data, divId);
                        displayPagination(pagination, divId);
                    } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
                        alert('검색 결과가 존재하지 않습니다.');
                    } else if (status === kakao.maps.services.Status.ERROR) {
                        alert('검색 결과 중 오류가 발생했습니다.');
                    }
                });
            }
            

             function initMap() {
                 // Call searchPlaces() when you want to initiate the search
                 //console.log("test");
                 $('#menu_wrap').attr('style', 'display:block');
                 searchPlaces();
             }
             
            // 키워드 검색을 요청하는 함수
            function searchPlaces() {

               var keyword = document.getElementById('keyword').value;
            
               //
               if (!keyword.replace(/^\s+|\s+$/g, '')) {
                  alert('키워드를 입력해주세요!');
                  return false;
               }

               // 장소검색 객체를 통해 키워드로 장소검색을 요청
               ps.keywordSearch(keyword, placesSearchCB);
            }

            // 장소검색이 완료됐을 때 호출되는 콜백함수
            function placesSearchCB(data, status, pagination) {
               if (status === kakao.maps.services.Status.OK) {

                  // 정상적으로 검색이 완료 시 검색 목록과 마커를 표출합니다
                  displayPlaces(data);

                  // 검색 결과 리스트의 페이지 번호를 표출
                  displayPagination(pagination);

               } else if (status === kakao.maps.services.Status.ZERO_RESULT) {

                  alert('검색 결과가 존재하지 않습니다.');
                  return;

               } else if (status === kakao.maps.services.Status.ERROR) {

                  alert('검색 결과 중 오류가 발생했습니다.');
                  return;

               }
            }

            // 검색 결과 목록과 마커를 표출하는 함수
            function displayPlaces(places) {

               var listEl = document.getElementById('placesList'), 
                  menuEl = document.getElementById('menu_wrap'), 
                  fragment = document.createDocumentFragment(), 
                  bounds = new kakao.maps.LatLngBounds(), 
                  listStr = '';

               // 검색 결과 목록에 추가된 항목들을 제거
               removeAllChildNods(listEl);

               for (var i = 0; i < places.length; i++) {

                  // 마커를 생성하고 지도에 표시
                  var placePosition = new kakao.maps.LatLng(places[i].y, places[i].x), 
                     itemEl = getListItem(i, places[i]); // 검색 결과 항목 Element를 생성

                  // 검색된 장소 위치를 기준으로 지도 범위를 재설정하기위해
                  // LatLngBounds 객체에 좌표를 추가합니다
                  bounds.extend(placePosition);

                  // 마커와 검색결과 항목에 mouseover 했을때
                  // 해당 장소에 인포윈도우에 장소명을 표시합니다
                  // mouseout 했을 때는 인포윈도우를 닫습니다
                  (function(marker, pname, praddress, paddress, plat, plng) {

                     // 리스트의 아이템을 클릭하면 정보들을 text 영역으로 전송 (hidden 사용가능)
                     itemEl.onclick = function() {
                                
                        //여행경로에 추가할지 여부를 확인하는 함수
                        function addTripMarker(){
                           if(confirm(pname + "을 경로에 추가하시겠습니까?")){
                                  markerPosition = new kakao.maps.LatLng(plat, plng);
                                  alert("추가 되었습니다.");
                                   return;
                               }else{
                                     return;
                               }
                        }
                        
                        //함수 호출
                        addTripMarker();
                        
                        var marker = new kakao.maps.Marker({
                           
                           content : pname,
                           
                           map : map, // 마커를 표시할 지도

                           position : markerPosition
                        });
                        
                        marker.polyline = null; // 선 정보를 저장할 프로퍼티 추가

                        var infowindow = new kakao.maps.InfoWindow({

                           content : pname, // 인포윈도우에 표시할 내용

                           removable : true

                        });

                        kakao.maps.event.addListener(marker, 'click', function() {
                           
                           //여행경로를 삭제할지 여부를 확인하는 함수
                           function deleteTripMarker(){
                              if(confirm(pname + "을 경로에서 삭제하시겠습니까?")){
                                     // 마커 클릭 시 해당 마커와 그에 따른 선을 지우는 함수 호출
                                 deleteMarkerAndLine(marker);
                                 alert("삭제 되었습니다.");
                                      return;
                                  }else{
                                        return;
                                  }
                           }
                           deleteTripMarker();
                        });
                        
                        

                        // 마커를 배열에 추가하고, 마커들끼리 순서대로 선을 그립니다.
                        markers.push(marker);
                        drawConnectingLines();
                        
                        mapping.push({
                              mapLat: plat, mapLng: plng, mapName: pname
                          });
                     };

                     // 모든 마커들끼리 순서대로 선을 그리는 함수
                     function drawConnectingLines() {
                         // 기존에 그려진 선들을 모두 제거합니다.
                           for (var i = 0; i < markers.length; i++) {
                             if (markers[i].polyline) {
                                 markers[i].polyline.setMap(null);
                             }
                         }

                           for (var i = 0; i < markers.length - 1; i++) {
                             var linePath = [markers[i].getPosition(), markers[i + 1].getPosition()];

                             markers[i].polyline = new kakao.maps.Polyline({
                                 path: linePath,
                                 strokeWeight: 3,
                                 strokeColor: '#ff0000',
                                 strokeOpacity: 0.7,
                                 strokeStyle: 'solid'
                             });

                             markers[i].polyline.setMap(map);
                         }
                     }      

                     // 마커와 그에 따른 선을 지우는 함수
                     function deleteMarkerAndLine(marker) {
                         var markerIndex = markers.indexOf(marker);
                         if (markerIndex !== -1) {
                             //markers.splice(markerIndex, 1);
                             mapping.splice(markerIndex, 1);
                             markers.splice(markerIndex, 1);
                             marker.setMap(null);

                             // 해당 마커와 그에 따른 선을 제거
                             if (marker.polyline) {
                                 marker.polyline.setMap(null);
                             }

                             // 다른 마커와 연결된 선도 함께 다시 그립니다.
                               drawConnectingLines();
                         }
                     }
                  })(marker, 
                     places[i].place_name,
                     places[i].road_address_name,
                     places[i].address_name, places[i].y,
                     places[i].x);

                  fragment.appendChild(itemEl);
               }

               // 검색결과 항목들을 검색결과 목록 Elemnet에 추가합니다
               listEl.appendChild(fragment);
               menuEl.scrollTop = 0;

               // 검색된 장소 위치를 기준으로 지도 범위를 재설정합니다
               map.setBounds(bounds);
            }

            // 검색결과 항목을 Element로 반환하는 함수입니다
            function getListItem(index, places) {

               var el = document.createElement('li'), 
                  itemStr = '<span class="markerbg marker_'
                           + (index + 1)
                           + '"></span>'
                           + '<div class="info" style="cursor:pointer;">'
                           + '   <h5>' + places.place_name + '</h5>';

               if (places.road_address_name) {
                  itemStr += '    <span>' + places.road_address_name
                        + '</span>' + '   <span class="jibun gray">'
                        + places.address_name + '</span>';
               } else {
                  itemStr += '    <span>' + places.address_name
                        + '</span>';
               }   
               itemStr += '  <span class="tel">' + places.phone
                     + '</span>';
                     +'</div>';

               el.innerHTML = itemStr;
               el.className = 'item';

               return el;
            }

            // 검색결과 목록 하단에 페이지 번호 표시
            function displayPagination(pagination) {
               var paginationEl = document.getElementById('pagination'), 
                  fragment = document.createDocumentFragment(), 
                  i

               // 기존에 추가된 페이지 번호 삭제
               while (paginationEl.hasChildNodes()) {
                  paginationEl.removeChild(paginationEl.lastChild)
               }

               for (i = 1; i <= pagination.last; i++) {
                  var el = document.createElement('a')
                  el.href = '#'
                  el.innerHTML = i

                  if (i === pagination.current) {
                     el.className = 'on'
                  } else {
                     el.onclick = (function(i) {
                        return function() {
                           pagination.gotoPage(i)
                        }
                     })(i)
                  }

                  fragment.appendChild(el)
               }
               paginationEl.appendChild(fragment)
            }

            // 지도 위에 표시되고 있는 마커를 모두 제거합니다
            function removeMarker() {
               for (var i = 0; i < markers.length; i++) {
                  markers[i].setMap(null);
               }
               markers = [];
            }

            // 검색결과 목록 또는 마커를 클릭했을 때 호출되는 함수입니다
            // 인포윈도우에 장소명을 표시합니다
            function displayInfowindow(marker, title) {
               var content = '<div style="padding:5px;z-index:1;">'
                        + title + '</div>';

               infowindow.setContent(content);
               infowindow.open(map, marker);
            }

            // 검색결과 목록의 자식 Element를 제거하는 함수입니다
            function removeAllChildNods(el) {
               while (el.hasChildNodes()) {
                  el.removeChild(el.lastChild);
               }
            }

            //첫번째 띄울 좌표
            
            markerPosition = [{}];
         
            // 첫번째 마커 생성

            for (var i = 0; i < markerPosition.length; i++) {
               // 마커를 생성
               var marker = new kakao.maps.Marker({
                  map : map, // 마커를 표시할 지도
                  position : markerPosition[i].latlng
               // 마커의 위치// 인포윈도우에 표출될 내용으로 HTML 문자열이나 document element가 가능합니다
               });

               // 마커에 표시할 인포윈도우를 생성합니다

               var infowindow = new kakao.maps.InfoWindow({

                  content : markerPosition[i].content, // 인포윈도우에 표시할 내용

                  removable : true

               });

               kakao.maps.event.addListener(marker, 'click', marker_click(map, marker, infowindow));

            }

            function marker_click(map, marker, infowindow) {

               return function() {

                  infowindow.open(map, marker);

               };

            }

            // 지도에 마커를 표시합니다
            marker.setMap(map);

            // 선택한 마커와 연결된 선을 삭제하는 함수
            function deleteSelectedMarkerAndLine() {
                var selectedMarker = markers[markers.length - 1]; // 마지막에 추가된 마커 선택

                if (selectedMarker) {
                    deleteMarkerAndLine(selectedMarker);
                }
            }
            
            
            $(document).ready(function() {
               $("#mapping").click(function() {
                  
                   if(confirm("경로 선택을 완료하시겠습니까?")){
                       // 마커 클릭 시 해당 마커와 그에 따른 선을 지우는 함수 호출
                   mappingMarker();
                   alert("완료 되었습니다.");
                   $('#searchMap').attr('style', 'display:none;');
                   $('#fixMap').attr('style', 'display:block;');
                   $('#menu_wrap').attr('style', 'display:none;');
                   
                 //location.href="tripRecordList";
                   return;
                    }else{
                          return;
                    }
               });
               
               $("#fixMap").click(function() {
                   $('#searchMap').attr('style', 'display:block;');
                   $('#fixMap').attr('style', 'display:none;');
                   $('#menu_wrap').attr('style', 'display:block;');
                });
               
               
               $("#addMap").click(function() {
                  console.log("tttttttt");
                  addTripData();
               });
               
            });
            
            //여행 경로추가 div를 생성해주는 함수
            function addTripData(){
               var addTripMapdata = document.getElementById('addSearchMap');
               console.log("aaaaaaaaaa");
               //addTripMapdata.innerHTML = "";
               for(var i=0; i<3; i++){
               var mapDataString = `<div id="searchMap${i+1}" style="height: 50px; width: 800px; border: solid 1px; margin-top: 10px;">
                                <div style="margin-top: 10px; margin-left: 25px;">
                                 <input type="text" value="" id="keyword" size="50" placeholder="키워드를 입력 해주세요.">
                                 <button onclick="initMap(); return false;">검색하기</button>
                                 <button type="submit" id="mapping">경로 선택/수정</button>
                              </div>
                              <div id="menu_wrap" class="map_wrap" style="margin-left: 710px; margin-top: 280px; height: 400px; width: 700px; border: solid 1px; display: none;">
                                 <ul id="placesList"></ul>
                                 <div id="pagination"></div>
                              </div>
                           </div>
                           <button type="button" id="fixMap" style="display: none">경로 수정</button>`
                  addTripMapdata.innerHTML += mapDataString;
            }
            }
            
            // 동적으로 html에 맵핑 되어있는 정보를 나타냄
            function mappingMarker() {
                var mappingCoordinates = document.getElementById('showMapping');
                
                mappingCoordinates.innerHTML ="";
                
                var mapDataArry = [];
                
                for (var i = 0; i < mapping.length; i++) {
                
                   var mappingObj = mapping[i];
                   
                   var mappingString = "<div class='mapData" + (i+1) + "'>"
                                   + "<input type='text' name='mapNo' value = '" + (i + 1) + "'>" 
                                   + "<input type='text' name='mapName' value = '" + mappingObj.mapName + "'>" 
                                   + "<input type='hidden' name='mapLat' value = '" + mappingObj.mapLat + "'>"
                                   + "<input type='hidden' name='mapLng' value = '" + mappingObj.mapLng + "'>"
                                   + "</div>";
						// 위에 여행일자 추가                   
                   mappingCoordinates.innerHTML += mappingString;
                   
                  //객체 생성
                   var mapDataObj = {
                                      mapNo : (i+1),
                                      mapName : mappingObj.mapName,
                                      mapLat : mappingObj.mapLat,
                                      mapLng : mappingObj.mapLng
                                   }
                  console.log(mapDataObj);
                 //객체를 배열로 변환
                  mapDataArry.push(mapDataObj);
                  console.log(mapDataArry);
                };
                 sendMappingData(mapDataArry);
                 console.log(JSON.stringify(mapDataArry));
            
             };
             
             
             function sendMappingData(data) {   
                 fetch('tripMappingInsert', {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json',
                     },
                     body: JSON.stringify(data),
                 })
                 .then(response => response.json())
                 .then(result => {
                     // 서버 응답 처리
                     //console.log("성공");
                 })
                 .catch(error => {
                     // 응답 실패 처리
                     //console.log("실패");
                 });
                 }
             
             function tripMemo(){
                
                
             }
             
         </script>
   </div>
</body>
</html>