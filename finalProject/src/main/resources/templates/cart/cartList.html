<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="@{layouts/default_layout}">
<head>
<script	src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
<meta charset="UTF-8">
<title>장바구니</title>
<style type="text/css">

table, th, td {
	border: 1px solid black;
	text-align: center;
	margin: 0 auto;
}
</style>
<script>
$(document).ready(function() {
	
	
		
	function handleClick(postId) {
    	
        $.ajax({
            url: 'ajaxCartList',
            type: 'get',
            data: {
                postId: postId,
                nowPage: 1,
                cntPerPage: 10
            }
        
        }).done(data => {
            console.log(data);
            displayData(data);
        }).fail(reject => console.log(reject));
    }

    // 클릭 이벤트 핸들러 자동 실행
    $('#pakage').click(function() {
        handleClick('3');
    });

    $('#jam').click(function() {
        handleClick('4');
    });

    $('#mul').click(function() {
        handleClick('5');
    });

	    // 데이터를 표시하는 함수
	function displayData(data) {
	    var html = ""; // 빈 문자열로 초기화
	    var tbody = $("tbody");
	    tbody.empty(); // tbody 내용 초기화
	
	    // 가져온 데이터를 순회하면서 처리	
	    $.each(data, (index, cartItem) => {
	        html += "<tr>" +
	            "<td><input type='checkbox' name='chk' data-cartid='" + cartItem.cartId + "' /></td>" +
	            "<td>" + cartItem.cartName + "</td>" +
	            "<td>" + cartItem.cartName + "</td>" +
	            "<td>" + cartItem.quantity + "</td>" +
	            "<td>" + cartItem.price + "</td>" +
	            "<td><button class='delete-btn'>삭제</button></td>" +
	            "</tr>";
	    });
	    
	    // tbody 내용을 업데이트
	    tbody.html(html);
	}
	    
	$("#pakage").trigger('click');
	
    // 체크박스 전체 선택/해제 기능
    $("#cbx_chkAll").click(function() {
        if ($(this).is(":checked")) {
            $("input[name=chk]").prop("checked", true);
        } else {
            $("input[name=chk]").prop("checked", false);
        }
    });

    // 각 체크박스의 클릭 이벤트 처리
    $("input[name=chk]").click(function() {
        var total = $("input[name=chk]").length;
        var checked = $("input[name=chk]:checked").length;

        if (total !== checked) {
            $("#cbx_chkAll").prop("checked", false);
        } else {
            $("#cbx_chkAll").prop("checked", true);
        }
    });
    
    // 삭제 버튼 클릭 시 선택된 항목 삭제
    $("body").on("click", ".delete-btn", function() {
        let row = $(this).closest("tr");
        let cartId = row.find("input[name='chk']").data("cartid");
        let url = "/cartDelete?cartId=" + cartId;

        fetch(url)
            .then(response => response.text())
            .then(text => {
                row.remove();
                top.document.location.reload();
            });
    });

    // 삭제 버튼 클릭 시 선택된 항목 삭제
    $("#delBtn").click(function() {
    let ckb = $('tbody input[type=checkbox]:checked');

    ckb.each(function() {
        let check = $(this);
        let id = check.val();
        let cartId = check.data("cartid"); // Retrieve cartId
        let url = "/cartDelete?cartId=" + cartId; // Use 'cartId'


        fetch(url)
            .then(response => response.text())
            .then(text => {
                check.parent().parent().remove();
                top.document.location.reload();     
            });
    });
  });
    
    $(document).ready(function() {
    	var nowPage = [[${paging.nowPage}]];
        $('#cntPerPage').on('change', function() {
            let selected = $('#cntPerPage').val();
            location.href = 'cartList?nowPage=' + nowPage + '&cntPerPage=' + selected;
        });
    });
    
    //현재 페이지에 데이터가 없으면 이전 페이지로 이동하는 구문
    var hasContent = [[${paging.end}]]-[[${paging.start}]] ;
    var currentPage = [[${paging.nowPage}]];
    
    console.log(hasContent);

    // 데이터가 없고 현재 페이지가 1보다 큰 경우 이전 페이지로 자동 이동
    if (hasContent == '-1' && currentPage > 1) {
    	let selected = $('#cntPerPage').val();
    	var prevPage = currentPage - 1;
        var prevPageUrl = location.href = 'cartList?nowPage=' + prevPage + '&cntPerPage=' + selected;
        window.location.href = prevPageUrl; // 자동으로 이동
    }
   
});

</script>
</head>
<body>
	<th:block layout:fragment="css">
		<!--    <link rel="stylesheet" th:href="@{/css/page/home.css}" >-->
	</th:block>
	<!-- index.html 고유 스크립트 추가 -->
	<th:block layout:fragment="script">
		<!--    <script th:src="@{/js/page/home.js}"></script>-->
	</th:block>
	<div layout:fragment="content" id="cartAllList" style="text-align: center;">
		<select id="cntPerPage">
			    <option th:value="5" th:text="|5줄 보기|" th:selected="${paging.cntPerPage == 5}" ></option>
			    <option th:value="10" th:text="|10줄 보기|" th:selected="${paging.cntPerPage == 10}" ></option>
			    <option th:value="15" th:text="|15줄 보기|" th:selected="${paging.cntPerPage == 15}" ></option>
			    <option th:value="20" th:text="|20줄 보기|" th:selected="${paging.cntPerPage == 20}" ></option>
		</select>
		<div>
			<button type="button" id="pakage">패키지</button>
			<button type="button" id="jam">숙소</button>
			<button type="button" id="mul">특산물</button>
		</div>
	
		<table>
			<thead>
				<tr>
					<th><input type="checkbox" id="cbx_chkAll" /></th>
					<th>상품사진</th>
					<th>상품 명</th>
					<th>상품수량</th>
					<th>상품가격</th>
					<th>삭제</th>
				</tr>
			</thead>
			<tbody>
			
				
			</tbody>
		</table>
		<button type="button">구매</button>
		<button type="button" id="delBtn">삭제</button>
		<div>
			<th:block th:if="${paging.startPage != 1}">
				<a th:href="@{cartList(nowPage=1, cntPerPage=${paging.cntPerPage})}"><<</a>
			</th:block>
			<th:block th:if="${paging.startPage != 1}">
				<a th:href="@{cartList(nowPage=${paging.startPage - 1}, cntPerPage=${paging.cntPerPage})}">&lt;</a>
			</th:block>
			<th:block th:each="p : ${#numbers.sequence(paging.startPage, paging.endPage)}">
				<th:block th:if="${p eq paging.nowPage}">
					<b th:text="${p}"></b>
				</th:block>
				<th:block th:if="${p ne paging.nowPage}">
					<a th:href="@{cartList(nowPage=${p}, cntPerPage=${paging.cntPerPage})}"	th:text="${p}"></a>
				</th:block>
			</th:block>
			<th:block
				th:if="${paging.nowPage != paging.lastPage and paging.lastPage > 5}">
				<a th:href="@{cartList(nowPage=${paging.endPage + 1}, cntPerPage=${paging.cntPerPage})}">&gt;</a>
			</th:block>
			<th:block th:if="${paging.endPage != paging.lastPage}">
				<a th:href="@{cartList(nowPage=${paging.lastPage}, cntPerPage=${paging.cntPerPage})}">>></a>
			</th:block>
		</div>
	</div>
</body>
</html>