<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="@{layouts/default_layout}"
      	layout:fragment="content"> 
      	
      	<!-- index.html 고유 CSS 추가 -->
<th:block layout:fragment="css">
</th:block>
<!-- index.html 고유 스크립트 추가 -->
<th:block layout:fragment="script">
</th:block>
<!-- Content -->

<style>
body {
	background-color: #fff;
	font-family: 'Roboto', sans-serif;
	font-weight: 400;
	color: #333;
}

h1 {
	color: #333;
}

table {
	width: 100%;
	border-collapse: collapse;
	margin-bottom: 20px;
}

th, td {
	padding: 10px;
	text-align: left;
	border: 1px solid #ddd;
}

th {
	background-color: #f5f5f5;
}

textarea {
	width: 100%;
	padding: 10px;
	border: 1px solid #ddd;
	resize: none;
}

button {
	background-color: #333;
	color: #fff;
	border: none;
	padding: 10px 20px;
	cursor: pointer;
}

button:hover {
	background-color: #222;
}

p {
    padding: 5px;
    margin-bottom: 5px;
    margin-left : 10px;
}

table {
	width: 100%;
	border-collapse: collapse;
	margin-bottom: 20px;
	margin: 10px;
	padding: 10px;
}
    .report-form {
        display: inline;
        background-color: #f2f2f2;
        padding: 10px;
        border-radius: 5px;
    }

    .report-form label {
        font-weight: bold;
    }

    .report-form select {
        width: 200px;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 3px;
    }

    .report-form input[type="submit"] {
        background-color: #333;
        color: white;
        padding: 8px 16px;
        border: 1px solid black;
        border-radius: 0;
        cursor: pointer;
    }

    .report-form input[type="submit"]:hover {
        background-color: #222;
    }
</style>

</head>
<body>
	<div align="center">
		<br>
		<br>
		<h1>게시글 상세보기</h1>
		<br>
	</div>
	<div id="ls2" align="center">
	
		<form id="frm" action="/admin/modifyNoticeInfo" th:object="${noticeVO}" method="post">
	 		<table border="1" style="width: 80%;" >
				<tr>
					
					<th width="70">순번</th>
					<td width="50" align="center" th:text="*{noticeNumber}" >
					</td>		
					<th width="100">작성자</th>
					<td width="150" align="center" th:text="*{writerId}"></td>
					<th width="100">작성일자</th>
					<td width="150" align="center" th:text="*{registDate}"></td>
					<th width="100">조회수</th>
					<td width="70" align="center" th:text="*{hit}"></td>
				</tr>
				<tr>
					<th colspan="2">제목</th>
					<td colspan="6"><textarea rows="1" th:text="*{title}" th:value="*{title}" name="title"  id="title" readonly ></textarea>
					</td>
				</tr>
				<tr>
					<th colspan="2">내용</th>
					<td colspan="6">
					 <div th:utext="*{content}" class="contentStyle"></div> 
					<!-- <th:textarea rows="10" cols="97" th:utext="*{content}"  id="content" name="content" readonly ></th:textarea> -->
					</td>
				</tr>
			</table>
			<div>
		
			 	<input type="hidden" name="noticeNumber" th:value="*{noticeNumber}">

			</div>
		</form>
	</div>
	<br>
	
	

    <div align="center">
    <!--  <div th:if="${id == board.memberId || id == 'manager'}"> -->
    		<!--  <input type="button" onclick="callFunction('E')" value="버튼"/>-->
            <button type="button" id='modify' class="modify" onclick="callFunction('E')">수정</button>&nbsp;&nbsp;
            <button type="button" onclick="callFunction('D')">삭제</button>&nbsp;&nbsp;
            <button type="button" onclick="callFunction('B')">되돌아가기</button>&nbsp;&nbsp;
     <!-- </div>-->
     </div>
 
<script th:inline="javascript">
 function callFunction(str){
	
	if(str=='E'){

		// 상세보기 할 member의 id값 가져오기
		document.getElementById('title').readOnly = false; 
		//document.getElementById('content').readOnly = false; 
		document.getElementById('modify').textContent = '등록'; 
		//document.getElementById('content').focus();
	    //$(".modify").attr("class","edit");		
	    
	    let modifyButton = document.getElementById("modify");
	    modifyButton.classList.add("edit");
        modifyButton.onclick = function() {
        	console.log("edit 버튼 눌렀다."); 
	    	
        	
    	let frm = document.getElementById("frm");
    	frm.submit();
            // edit 버튼이 클릭되었을 때의 동작을 여기에 작성
        };
	
	}
 }		 					

 
 
 
 $(document).ready(function() {
		// 승인 버튼 클릭 시 발생 이벤트 설정
		$('.registrationButton').on('click', go);
		 // $('#frm').on('submit', loginAccountcheck);
	/* 	$('.rejectButton').on('click', authReject); */
		$.noConflict();
	});
	
	// 승인 버튼 클릭 시 발생 이벤트
	function go(e){
		e.stopPropagation();
		
		Swal.fire({
		      title: '저장하시겠습니까',
		      icon: 'question',
		      showCancelButton: true,
		      confirmButtonColor: '#3085d6',
		      cancelButtonColor: '#d33',
		      confirmButtonText: '저장',
		      cancelButtonText: '취소',
		      
	    }).then((result) => {
		      if (result.isConfirmed) {
		          
		    	  //post방식으로 페이지 전환
				  console.log('hi');
				 // document.getElementById('frm').submit();
				  $('#frm')[0].submit();
		      }
		    })
		 
	   	    
	} 
	
	
	ClassicEditor
	.create(document.querySelector('#editor'), {
		/* htmlEncodeOutput: false, */
		ckfinder: {
			uploadUrl : 'upload'	
		}
	
		
	})
	.then(editor => {
		console.log('Editor was initialized');
		
		document.getElementById("cancelBtn").addEventListener("click",function(){
			const data = editor.getData();
			//Data 변수에 저장된 데이터를 파싱하여 이미지 태크를 찾음
			const imgTags = Array.from(new DOMParser().parseFromString(data, 'text/html').querySelectorAll('img'));
			
			const filenames = imgTags.map(img=> {
				const src = img.getAttribute('src');
				
				return src.substring(src.lastIndexOf('/')+1);
			});
			console.log(filenames);
			fetch(`/deleteImg`,{
				method: 'POST',
				headers:{
					'Content-Type':'application/json'
				},
				body: JSON.stringify({ filenames })
			})
			.then(response => response.text())
			.then(message => {
				console.log(message);
				editor.setData('');
			})
			
		})
		
		
		var formObj = $("#frm");
		
		//document.getElementById("editorForm").addEventListener("submit",function(event){
		$("button[type='submit']").on("click",function(event){
				
			event.preventDefault();
	
			const data = editor.getData();
			
			let objData = serializeObject();
			
			console.log(data);
			const {  writerId, registDate, title} = objData;
			var combinedData={
				content: data,
				writerId: writerId,
				registDate: registDate,
				title: title
			};
			console.log(combinedData);
	
			
			var str="";
			
			str +="<input type='hidden' name='content' value='"+combinedData.content+"'>";
			
			
			const imgTags = Array.from(new DOMParser().parseFromString(data, 'text/html').querySelectorAll('img'));
			
			const filenames = imgTags.map(img=> {
				const src = img.getAttribute('src');
				
				return src;
			});		
			$.each(filenames,function(i,obj){
				str += "<input type ='hidden' name='editorAttachList["+i+"].savedImg' value='c:/"+obj+"'>";
			});
	
			formObj.append(str);
			document.getElementById('frm').action = "/noticeProc";
			document.getElementById('frm').submit();
			
			
			
			
		})
		//////////////////////////////////////////////////////////////////////
	})
	.catch(error => {
		console.error(error);
	});
		
	function serializeObject(){
		let formData = $('form').serializeArray();
		let formObject={};
		$.each(formData, function(idx,obj){
			//let field = obj.name;
			//let val= obj.value;
			formObject[obj.name] = obj.value;
			//formObject[field] = val;
		});
		
		return formObject;
	}
 </script>
		
		


</body>
</html>