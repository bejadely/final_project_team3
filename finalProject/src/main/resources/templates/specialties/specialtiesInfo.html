<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
   xmlns:th="http://www.thymeleaf.org"
   xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
   layout:decorate="@{layouts/default_layout}">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>

<style>
form {
   text-align: center;
}

.contentStyle{
   width:400px;
   height:400px;
   margin: 0 auto;
}
.pt img{
   width:200px;
   height:200px;
}
</style>

</head>
<body>

<div layout:fragment="content">
 <section class="property-details-section spad">
        <div class="container">
            <div class="row">
            	<div class="col-7">
            	
            	</div>
            	<div class="col-5">
            	
            	</div>
            </div>
                <!-- 리뷰 -->
        <div class="review">
            <h7 id="reviewCount"></h7>
            <hr>
             <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio1" value="1">
                <label class="form-check-label" for="inlineRadio1">1점</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio2" value="2">
                <label class="form-check-label" for="inlineRadio2">2점</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio3" value="3">
                <label class="form-check-label" for="inlineRadio3">3점</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio4" value="4">
                <label class="form-check-label" for="inlineRadio4">4점</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio5" value="5" th:checked="true">
                <label class="form-check-label" for="inlineRadio5">5점</label>
            </div>
            <div class="input-group mb-3">
                <input id="reviewInput" type="text" class="form-control" placeholder="리뷰 작성" aria-label="추억을 남겨보세요!" aria-describedby="button-addon2">
                <button class="btn btn-outline-secondary" type="button" id="addReview">리뷰 등록</button>
            </div>
            <hr id="afterReview">
            <div class="d-grid gap-2 col-6 mx-auto">
                <button class="btn btn-outline-info justify-content-center" id="moreReview" type="button"
                        data-page="1" >
                    더보기
                </button>
            </div>
            <hr>
           
        </div>   
             <input type="hidden" id="id" th:value="${session.sessionId}">
        </div>
              
    </section>
    <!-- Property Details Section End -->


<script>


   var content = '[[${info.content }]]';
   var postId = '[[${info.postId}]]';
   var memberId = $("#id").val();
   $(document).ready(function(){
         
      (function(){
         $.getJSON("getAttachList",{postId:postId},function(arr){
            var str="";
            var str2="";
            $(arr).each(function(i, attach){
               if(i==0){
                  str+=`<img src="${attach.loadingImg}" class="product-big-img"  alt="">`   
               }
               else{
                  str2+=`<div class="pt" data-imgbigurl="${attach.loadingImg}"><img
                            src="${attach.loadingImg}" alt=""></div>`
               }
            });
            $(".product-pic-zoom").html(str);
            $(".product-thumbs-track.ps-slider.owl-carousel").html(str2);
         });
      })();
         
      
      
      
      $(document).on('click', '.nice-select.form-control', function() {
         //var count = $(this).attr("data-value");
         //var count = $(".current").text();
         var count = $("div.count  li.selected").attr("data-value");
         var price = $(".opt_select > option:selected").attr("value2");
         var specialtyType = $(".opt_select > option:selected").attr("value1");
         var discountRate = $(".opt_select > option:selected").attr("value3");
         var opt = $(".opt_select").val();
         var finalPrice = 0;
         var discountPrice = 0;
         var str = '';
         if(discountRate !=null){
            finalPrice = price * count*(1-(discountRate/100));
            discountPrice = price * count * (discountRate/100);
         }else{
            finalPrice = price * count;
         }

         str += '<p><label>수량 : </label><span class="count">&nbsp;' + count + '</span>&nbsp;&nbsp;&nbsp;<br>';   
   
         str += '<label>옵션 : </label><span class="specialtyType">&nbsp;' + specialtyType + '</span>&nbsp;&nbsp;&nbsp;';   
         str+=`<input type="hidden" class="specType" value="${specialtyType}"><br>`
         
         str   += '<label>가격 : </label><span>&nbsp;' + price + ' 원</span><br>';
         str += '<label>할인 금액: </label><span>&nbsp;' + discountPrice + '원</span></p>';
         str += '<h4><label>결제금액 : </label><span class="finalPrice">&nbsp;' + finalPrice + ' 원</span></h4>'; 
         
         
         $(".selected_option").html(str);
      });
      
      
      
   });
   
       // 결제 버튼 클릭 이벤트 처리
       document.getElementById('kakaoPay').addEventListener('click', function() {
           // 여기에 결제 페이지로 이동하는 코드 추가
           // 예를 들어, window.location.href = '결제페이지URL';
          
           let totalAmount = parseInt($("span.finalPrice").text());
           let orderName = "[[ ${info.title} ]]";
           let postId = "[[ ${info.postId} ]]"
           let quantity = parseInt($("span.count").text());
           let specialtyType = $(".specType").val();
           console.log(totalAmount);
           console.log(orderName);
           console.log(postId);
           console.log(quantity);
           console.log(specialtyType);
           console.log(memberId);
           $.ajax({
              type:'post',
              url:'/common/payment/ready',
              data:{
                 totalAmount: totalAmount,
                 orderName : orderName,
                 quantity : quantity,
                 postId: postId,
                 specialtyType: specialtyType,
                 partnerUserId : memberId
              },
              success:function(response){
                 location.href = response.next_redirect_pc_url
              }
              
           }); 
       });

       document.getElementById('cartBtn').addEventListener('click',function(){
          let totalAmount = parseInt($("span.finalPrice").text());
           let orderName = "[[ ${info.title} ]]";
           let postId = "[[ ${info.postId} ]]"
           let quantity = parseInt($("span.count").text());
           let specialtyType = $(".specType").val();
          $.ajax({
             type:'post',
             url:'/common/cartInsert',
             data:{
                price: totalAmount,
                 cartName : orderName,
                 quantity : quantity,
                 postId: postId,
                 optionId: specialtyType,
                 memberId : memberId         
             },
             success:function(message){
                alert(message);
             }
          });
       });
       
       
       function getPackageDetailInfoReview(postId, callback) {
            $.ajax({
                type: 'GET',
                url: '/packageInfoReview',
                data: {
                    'postId': postId
                }
            })
            .done(function (data, textStatus, jqXHR){
                console.log('done');

                callback(data);
            })
            .fail(function (jqXHR, textStatus, errorThrown){
                console.log('fail');

                callback(null);
            })
        }
       
       function appendPackageDetailInfoReview(data, postId) {
           $('#reviewCount').text(data.totalCount + '개의 리뷰');
           $('#reviewCount').data('totalCount', data.totalCount);
           if(data.totalCount == 0) {
               $('#moreReview').addClass('disabled');
           }
           $('#moreReview').data('postId', postId);
   
           if(data.packageDetailReviewVoList.length > 0) {
               appendReview(data.packageDetailReviewVoList, postId);
           }
       }
   
       //모달창 리뷰 페이징
       $(document).on('click', '#moreReview', function () {
           let page = $(this).data('page');
   
           page = Number(page)+1;
   
           $.ajax({
               type: 'GET',
               url: '/packageReview',
               data: {
                   'postId' : postId,
                   'page' : page
               }
           })
           .done(function(data, textStatus, jqXHR) {
               console.log('done');
   
               appendReview(data, postId);
               changeInfoMoreReviewButton(page);
           })
           .fail(function(jqXHR, textStatus, errorThrown) {
               console.log('fail');
   
           })
       });
   
       function appendReview(data, postId) {
           let node = ``;
           for(let i = 0; i < data.length; i++) {
               let stars = '';
               for(let j = 1; j <= 5; j++) {
                   if(j <= data[i].grade) {
                       stars += '★';
                   } else {
                       stars += '☆';
                   }
               }
   
               let date = data[i].writeDate.substring(0,10);
   
               node += `
                   <div class="review-content">
                       <p>
                           <span class="writerId">${data[i].writerId}</span>
                           <span class="grade">${stars}</span>
                           <span class="writeDate" style="float: right;">${date}&emsp;
                               <button type="button" class="btn btn-secondary btn-sm deleteReview" data-content-id="${postId}" data-review-id="${data[i].reviewId}">삭제</button>
                           </span>
                           <br>
                           <span class="content">${data[i].content}</span>
                       </p>
                   </div>
               `;
           }
           $('#afterReview').before(node);
       }
   
       function changeInfoMoreReviewButton(page) {
           $('#moreReview').data('page', page);
   
           let totalCount = $('#reviewCount').data('totalCount');
           let reviewCount = $('.review-content').length;
   
           if(totalCount == reviewCount) {
               $('#moreReview').addClass('disabled');
           }
       }
   
       //리뷰 등록
       $(document).on('click', '#addReview', function() {
           let contentId = $('#moreReview').data('postId');
   
           let checkedgrade = $('input[name=inlineRadioOptions]:checked').val();
           if(checkedgrade == null) {
               alert("점수를 체크해주세요.");
               return;
           }
   
           let reviewContent = $('#reviewInput').val();
           if(reviewContent == null|| reviewContent.replaceAll(' ', '') == '') {
               alert("내용을 입력해주세요.");
               return;
           }
           //  ajax 들어가서 로그인 되어있는지 먼저 확인 - 안되면 바로 fail throw new Exception(); 예외 일부러 발생시켜주기
           $.ajax({
               type: 'POST',
               url: '/common/packageReview',
               data : {
                   'grade' : checkedgrade,
                   'content' : reviewContent,
                   'originPostId' : postId
               }
           })
           .done(function (data, textStatus, jqXHR){
               console.log('done');
   
               //  data는 totalCount이고, x개의 리뷰를 바꿔야함
               $('#reviewCount').text(data.totalCount + '개의 리뷰');
               $('#reviewCount').data('totalCount', data.totalCount);
   
               $('.review-content').remove();
               appendReview(data.recentReviewList, postId);
   
               changeInfoMoreReviewButton(1);
               clearInput();
   
               alert('리뷰가 등록되었습니다.');
           })
           .fail(function (jqXHR, textStatus, errorThrown) {
               console.log('fail');
   
               let errorMessage = JSON.parse(jqXHR.responseText).message;
               if(errorMessage == 'no login') {
                   alert('로그인을 해주세요.');
               } else if(errorMessage == 'not insert') {
                   alert('리뷰가 등록되지 않았습니다.');
               }
           })
   
       })
   
       //리뷰 삭제
       $(document).on('click', '.deleteReview', function() {
   
           let writerId = $(this).parent().siblings('.writerId').text();
           let reviewId = $(this).data('reviewId');
           //  ajax로 가서 session에 저장된 아이디랑 writerId랑 같은지 확인 - 같지 않다면 fail 
           $.ajax({
               type: 'DELETE',
               url: "/common/packageReview",
               data: {
                   'postId' : postId,
                   'writerId' : writerId,
                   'reviewId' : reviewId
               }
           })
           .done(function (data, textStatus, jqXHR){
               console.log('done');
   
               $('#reviewCount').text(data.totalCount + '개의 리뷰');
               $('#reviewCount').data('totalCount', data.totalCount);
   
               $('.review-content').remove();
               appendReview(data.recentReviewList, postId);
   
               changeInfoMoreReviewButton(1);
   
               alert('리뷰가 삭제되었습니다.');
           })
           .fail(function (data, textStatus, jqXHR) {
               console.log('fail');
   
               let errorMessage = JSON.parse(jqXHR.responseText).message;
               if(errorMessage == 'no login') {
                   alert('로그인을 해주세요.');
               } else if(errorMessage == 'not same') {
                   alert('본인의 리뷰만 삭제할 수 있습니다.');
               } else if(errorMessage == 'not delete') {
                   alert('리뷰가 삭제되지 않았습니다.');
               }
           })
   
       })
   
       function clearInput() {
           $('#reviewInput').val('');
           $('#inlineRadio5').prop('checked', true);
       }
       
       document.getElementById('question').addEventListener('click',function(){
          console.log("asdsad");
          location.href="/common/memberQueForm?productId="+'[[${info.postId}]]'
       })
       
</script>
</div>
</body>
</html>